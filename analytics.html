{% extends 'base.html' %}
{% block title %}Advanced Analytics{% endblock %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4 text-primary">Advanced Analytics</h2>
  <div class="row g-4">
    <!-- Trends Over Time -->
    <div class="col-12 col-lg-12">
      <div class="card shadow-lg h-100 p-4 border-0">
        <div class="card-body">
          <form method="get" action="/analytics" class="row g-3 align-items-end mb-3">
            <input type="hidden" name="section" value="trend">
            <input type="hidden" name="packer_start_date" value="{{ request.args.get('packer_start_date', '') }}">
            <input type="hidden" name="packer_end_date" value="{{ request.args.get('packer_end_date', '') }}">
            <input type="hidden" name="shift_start_date" value="{{ request.args.get('shift_start_date', '') }}">
            <input type="hidden" name="shift_end_date" value="{{ request.args.get('shift_end_date', '') }}">
            <div class="col-auto">
              <label for="trend_start_date" class="form-label fs-5">Start Date:</label>
              <input type="date" id="trend_start_date" name="trend_start_date" class="form-control form-control-lg" value="{{ request.args.get('trend_start_date', '') }}">
            </div>
            <div class="col-auto">
              <label for="trend_end_date" class="form-label fs-5">End Date:</label>
              <input type="date" id="trend_end_date" name="trend_end_date" class="form-control form-control-lg" value="{{ request.args.get('trend_end_date', '') }}">
            </div>
            <div class="col-auto">
              <label for="trend_chart_type" class="form-label fs-5">Chart Type:</label>
              <select id="trend_chart_type" name="chart_type" class="form-select form-select-lg">
                <option value="bar" {% if request.args.get('chart_type', 'bar') == 'bar' %}selected{% endif %}>Bar</option>
                <option value="line" {% if request.args.get('chart_type') == 'line' %}selected{% endif %}>Line</option>
                <option value="scatter" {% if request.args.get('chart_type') == 'scatter' %}selected{% endif %}>Scatter</option>
              </select>
            </div>
            <div class="col-auto">
              <button type="submit" class="btn btn-primary btn-lg px-4">Update</button>
            </div>
            <div class="col-auto">
              <a href="/analytics?packer_start_date={{ request.args.get('packer_start_date', '') }}&packer_end_date={{ request.args.get('packer_end_date', '') }}&shift_start_date={{ request.args.get('shift_start_date', '') }}&shift_end_date={{ request.args.get('shift_end_date', '') }}&chart_type={{ request.args.get('chart_type', 'bar') }}" class="btn btn-secondary btn-lg px-4">Clear</a>
            </div>
          </form>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="card-title mb-0 fw-bold display-6">Trends Over Time</h3>
            <button class="btn btn-outline-primary btn-lg" id="exportTrendPng" aria-label="Export trend chart as PNG"><i class="bi bi-image"></i> PNG</button>
          </div>
          <div id="trendChart" class="analytics-chart" tabindex="0" aria-label="Trend chart" style="height: 480px;"></div>
          <button class="btn btn-link mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#trendTableCollapse" aria-expanded="false" aria-controls="trendTableCollapse">
            Show Data Table
          </button>
          <div class="collapse mt-2" id="trendTableCollapse">
            <div class="card card-body shadow-sm">
              <table class="table table-striped table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Date</th>
                    <th>Cases Packed</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in trend_table %}
                  <tr>
                    <td>{{ row[0] }}</td>
                    <td>{{ row[1] }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Packer Comparison -->
    <div class="col-12 col-lg-12">
      <div class="card shadow-lg h-100 p-4 border-0">
        <div class="card-body">
          <form method="get" action="/analytics" class="row g-3 align-items-end mb-3">
            <input type="hidden" name="section" value="packer">
            <input type="hidden" name="trend_start_date" value="{{ request.args.get('trend_start_date', '') }}">
            <input type="hidden" name="trend_end_date" value="{{ request.args.get('trend_end_date', '') }}">
            <input type="hidden" name="shift_start_date" value="{{ request.args.get('shift_start_date', '') }}">
            <input type="hidden" name="shift_end_date" value="{{ request.args.get('shift_end_date', '') }}">
            <div class="col-auto">
              <label for="packer_start_date" class="form-label fs-5">Start Date:</label>
              <input type="date" id="packer_start_date" name="packer_start_date" class="form-control form-control-lg" value="{{ request.args.get('packer_start_date', '') }}">
            </div>
            <div class="col-auto">
              <label for="packer_end_date" class="form-label fs-5">End Date:</label>
              <input type="date" id="packer_end_date" name="packer_end_date" class="form-control form-control-lg" value="{{ request.args.get('packer_end_date', '') }}">
            </div>
            <div class="col-auto">
              <label for="packer_chart_type" class="form-label fs-5">Chart Type:</label>
              <select id="packer_chart_type" name="packer_chart_type" class="form-select form-select-lg">
                <option value="bar" {% if request.args.get('packer_chart_type', 'bar') == 'bar' %}selected{% endif %}>Bar</option>
                <option value="line" {% if request.args.get('packer_chart_type') == 'line' %}selected{% endif %}>Line</option>
                <option value="scatter" {% if request.args.get('packer_chart_type') == 'scatter' %}selected{% endif %}>Scatter</option>
              </select>
            </div>
            <div class="col-auto">
              <button type="submit" class="btn btn-primary btn-lg px-4">Update</button>
            </div>
            <div class="col-auto">
              <a href="/analytics?trend_start_date={{ request.args.get('trend_start_date', '') }}&trend_end_date={{ request.args.get('trend_end_date', '') }}&shift_start_date={{ request.args.get('shift_start_date', '') }}&shift_end_date={{ request.args.get('shift_end_date', '') }}&packer_chart_type=bar" class="btn btn-secondary btn-lg px-4">Clear</a>
            </div>
          </form>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="card-title mb-0 fw-bold display-6">Packer Comparison</h3>
            <button class="btn btn-outline-primary btn-lg" id="exportPackerPng" aria-label="Export packer chart as PNG"><i class="bi bi-image"></i> PNG</button>
          </div>
          <div id="packerComparisonChart" class="analytics-chart" tabindex="0" aria-label="Packer comparison chart" style="height: 480px;"></div>
          <button class="btn btn-link mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#packerTableCollapse" aria-expanded="false" aria-controls="packerTableCollapse">
            Show Data Table
          </button>
          <div class="collapse mt-2" id="packerTableCollapse">
            <div class="card card-body shadow-sm">
              <table class="table table-striped table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Packer Name</th>
                    <th>Cases Packed</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in packer_table %}
                  <tr>
                    <td>{{ row[0] }}</td>
                    <td>{{ row[1] }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Shift Comparison -->
    <div class="col-12 col-lg-12">
      <div class="card shadow-lg h-100 p-4 border-0">
        <div class="card-body">
          <form method="get" action="/analytics" class="row g-3 align-items-end mb-3">
            <input type="hidden" name="section" value="shift">
            <input type="hidden" name="trend_start_date" value="{{ request.args.get('trend_start_date', '') }}">
            <input type="hidden" name="trend_end_date" value="{{ request.args.get('trend_end_date', '') }}">
            <input type="hidden" name="packer_start_date" value="{{ request.args.get('packer_start_date', '') }}">
            <input type="hidden" name="packer_end_date" value="{{ request.args.get('packer_end_date', '') }}">
            <div class="col-auto">
              <label for="shift_start_date" class="form-label fs-5">Start Date:</label>
              <input type="date" id="shift_start_date" name="shift_start_date" class="form-control form-control-lg" value="{{ request.args.get('shift_start_date', '') }}">
            </div>
            <div class="col-auto">
              <label for="shift_end_date" class="form-label fs-5">End Date:</label>
              <input type="date" id="shift_end_date" name="shift_end_date" class="form-control form-control-lg" value="{{ request.args.get('shift_end_date', '') }}">
            </div>
            <div class="col-auto">
              <label for="shift_chart_type" class="form-label fs-5">Chart Type:</label>
              <select id="shift_chart_type" name="shift_chart_type" class="form-select form-select-lg">
                <option value="bar" {% if request.args.get('shift_chart_type', 'bar') == 'bar' %}selected{% endif %}>Bar</option>
                <option value="line" {% if request.args.get('shift_chart_type') == 'line' %}selected{% endif %}>Line</option>
                <option value="scatter" {% if request.args.get('shift_chart_type') == 'scatter' %}selected{% endif %}>Scatter</option>
              </select>
            </div>
            <div class="col-auto">
              <button type="submit" class="btn btn-primary btn-lg px-4">Update</button>
            </div>
            <div class="col-auto">
              <a href="/analytics?trend_start_date={{ request.args.get('trend_start_date', '') }}&trend_end_date={{ request.args.get('trend_end_date', '') }}&packer_start_date={{ request.args.get('packer_start_date', '') }}&packer_end_date={{ request.args.get('packer_end_date', '') }}&shift_chart_type=bar" class="btn btn-secondary btn-lg px-4">Clear</a>
            </div>
          </form>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="card-title mb-0 fw-bold display-6">Shift Comparison</h3>
            <button class="btn btn-outline-primary btn-lg" id="exportShiftPng" aria-label="Export shift chart as PNG"><i class="bi bi-image"></i> PNG</button>
          </div>
          <div id="shiftComparisonChart" class="analytics-chart" tabindex="0" aria-label="Shift comparison chart" style="height: 480px;"></div>
          <button class="btn btn-link mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#shiftTableCollapse" aria-expanded="false" aria-controls="shiftTableCollapse">
            Show Data Table
          </button>
          <div class="collapse mt-2" id="shiftTableCollapse">
            <div class="card card-body shadow-sm">
              <table class="table table-striped table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Shift</th>
                    <th>Cases Packed</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in shift_table %}
                  <tr>
                    <td>{{ row[0] }}</td>
                    <td>{{ row[1] }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Plotly.js CDN -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
// Toast helper
function showToast(msg, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-bg-${type} border-0 show`;
  toast.role = 'alert';
  toast.ariaLive = 'assertive';
  toast.ariaAtomic = 'true';
  toast.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
  document.getElementById('toast-container').appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}
// Chart data
var trendData = {{ trend_data | tojson | safe }};
var packerData = {{ packer_data | tojson | safe }};
var shiftData = {{ shift_data | tojson | safe }};
var chartType = '{{ chart_type }}';
// Chart layouts
var trendLayout = {title: 'Cases Packed Over Time', xaxis: {title: 'Date'}, yaxis: {title: 'Cases Packed'}, legend: {orientation: 'h'}, autosize: true};
var packerLayout = {title: 'Packer Comparison', xaxis: {title: 'Packer'}, yaxis: {title: 'Cases Packed'}, legend: {orientation: 'h'}, autosize: true};
var shiftLayout = {title: 'Shift Comparison', xaxis: {title: 'Shift'}, yaxis: {title: 'Cases Packed'}, legend: {orientation: 'h'}, autosize: true};
// Render charts
Plotly.newPlot('trendChart', trendData, trendLayout, {responsive: true});
Plotly.newPlot('packerComparisonChart', packerData, packerLayout, {responsive: true});
Plotly.newPlot('shiftComparisonChart', shiftData, shiftLayout, {responsive: true});
// Export PNG handlers
function exportChartPng(chartId, filename) {
  Plotly.downloadImage(chartId, {format: 'png', filename: filename, height: 600, width: 900, scale: 2});
  showToast('Chart exported as PNG!', 'success');
}
document.getElementById('exportTrendPng').onclick = () => exportChartPng('trendChart', 'trend_chart');
document.getElementById('exportPackerPng').onclick = () => exportChartPng('packerComparisonChart', 'packer_comparison_chart');
document.getElementById('exportShiftPng').onclick = () => exportChartPng('shiftComparisonChart', 'shift_comparison_chart');
// Drill-down: click on bar/point to filter
Plotly.on('plotly_click', function(data) {
  var chartId = data.event.target.id;
  if (chartId === 'trendChart' && data.points.length) {
    var period = data.points[0].x;
    var url = new URL(window.location.href);
    url.searchParams.set('period', period);
    window.location.href = url.toString();
  }
  if (chartId === 'packerComparisonChart' && data.points.length) {
    var packer = data.points[0].x;
    var url = new URL(window.location.href);
    url.searchParams.set('packer', packer);
    window.location.href = url.toString();
  }
  if (chartId === 'shiftComparisonChart' && data.points.length) {
    var shift = data.points[0].x;
    var url = new URL(window.location.href);
    url.searchParams.set('shift', shift);
    window.location.href = url.toString();
  }
});
// Accessibility: focusable charts, ARIA labels, keyboard navigation
Array.from(document.getElementsByClassName('analytics-chart')).forEach(function(chart) {
  chart.setAttribute('tabindex', '0');
  chart.setAttribute('role', 'img');
  chart.setAttribute('aria-label', chart.getAttribute('aria-label'));
  chart.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
      chart.click();
    }
  });
});
</script>
{% endblock %} 