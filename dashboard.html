{% extends 'base.html' %}

{% block title %}Dashboard - Packed Orders{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <h1><i class="fas fa-tachometer-alt me-3"></i>Dashboard - Packed Orders</h1>
        <p class="lead mb-0">Monitor and manage all packed orders with advanced filtering</p>
    </div>
</div>

<div class="card page-fade" id="dashboardPageFade">
  <div class="card-header">
    <h3 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Orders</h3>
  </div>
  <div class="card-body">
    <form method="get" action="/dashboard" class="needs-validation" novalidate>
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <label for="transaction_number" class="form-label"><i class="fas fa-hashtag me-1"></i>Transaction #</label>
          <input type="text" id="transaction_number" name="transaction_number" class="form-control" value="{{ request.args.get('transaction_number', '') }}" placeholder="Partial or full">
        </div>
        <div class="col-md-3">
          <label for="packer" class="form-label"><i class="fas fa-user me-1"></i>Packer Name</label>
          <input type="text" id="packer" name="packer" class="form-control" value="{{ request.args.get('packer', '') }}" placeholder="Enter packer name">
        </div>
        <div class="col-md-3">
          <label for="start_date" class="form-label"><i class="fas fa-calendar me-1"></i>Start Date</label>
          <input type="date" id="start_date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
        </div>
        <div class="col-md-3">
          <label for="end_date" class="form-label"><i class="fas fa-calendar me-1"></i>End Date</label>
          <input type="date" id="end_date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
        </div>
      </div>
      
      <div class="text-center">
        <button type="submit" class="btn btn-primary me-2"><i class="fas fa-filter me-2"></i>Apply Filters</button>
        <button type="button" class="btn btn-secondary" onclick="window.location.href='/dashboard'"><i class="fas fa-times-circle me-2"></i>Clear All</button>
      </div>
    </form>
    
         {% if success_message %}
       <div class="alert alert-success mt-3"><i class="fas fa-check-circle me-2"></i>{{ success_message }}</div>
     {% endif %}
     {% if error_message %}
       <div class="alert alert-danger mt-3"><i class="fas fa-exclamation-triangle me-2"></i>{{ error_message }}</div>
     {% endif %}
   </div>
 </div>

 <div class="card">
   <div class="card-header">
     <div class="row align-items-center">
       <div class="col">
         <h3 class="mb-0"><i class="fas fa-table me-2"></i>Order Results</h3>
       </div>
       <div class="col-auto">
         <form id="exportForm" method="get" action="/dashboard/export" class="d-flex align-items-center gap-2">
           <input type="hidden" name="packer" value="{{ request.args.get('packer', '') }}">
           <input type="hidden" name="start_date" value="{{ request.args.get('start_date', '') }}">
           <input type="hidden" name="end_date" value="{{ request.args.get('end_date', '') }}">
           <input type="hidden" name="transaction_number" value="{{ request.args.get('transaction_number', '') }}">
           <input type="hidden" name="page" value="{{ page }}">
                       <select name="export_scope" class="form-select form-select-sm" style="min-width: 120px;">
              <option value="all">All data</option>
              <option value="page">This page</option>
            </select>
            <button type="submit" class="btn btn-success btn-sm"><i class="fas fa-download"></i></button>
         </form>
       </div>
     </div>
   </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th><i class="fas fa-hashtag me-1"></i>Transaction Number</th>
            <th><i class="fas fa-user me-1"></i>Packer Name</th>
            <th><i class="fas fa-clock me-1"></i>Timestamp</th>
            <th><i class="fas fa-boxes me-1"></i>Case Count</th>
            {% if manager_authenticated %}
              <th><i class="fas fa-cogs me-1"></i>Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for id, transaction_number, packer_name, timestamp, case_count in records %}
          <tr>
            <td><strong>{{ transaction_number }}</strong></td>
            <td>{{ packer_name }}</td>
            <td>{{ timestamp }}</td>
            <td><span class="badge bg-primary">{{ case_count }}</span></td>
            {% if manager_authenticated %}
            <td>
              <div class="btn-group" role="group">
                <a href="/edit/{{ id }}" class="btn btn-sm btn-warning" title="Edit"><i class="fas fa-edit"></i></a>
                <form method="POST" action="/delete/{{ id }}" style="display:inline-block" onsubmit="return confirm('Are you sure you want to delete this record?');">
                  <button type="submit" class="btn btn-sm btn-danger" title="Delete"><i class="fas fa-trash"></i></button>
                </form>
              </div>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    {% if not records %}
      <div class="text-center py-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No orders found</h5>
        <p class="text-muted">Try adjusting your filter criteria</p>
      </div>
    {% endif %}
    
    <!-- Pagination -->
    {% if total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center">
        {% if page > 1 %}
          <li class="page-item">
            <a class="page-link" href="{{ build_url(page - 1) }}"><i class="fas fa-chevron-left"></i></a>
          </li>
        {% endif %}
        
        {% for p in range(1, total_pages + 1) %}
          {% if p == page %}
            <li class="page-item active">
              <span class="page-link">{{ p }}</span>
            </li>
          {% elif p <= 3 or p > total_pages - 3 or (p >= page - 1 and p <= page + 1) %}
            <li class="page-item">
              <a class="page-link" href="{{ build_url(p) }}">{{ p }}</a>
            </li>
          {% elif p == 4 and page > 5 %}
            <li class="page-item disabled">
              <span class="page-link">...</span>
            </li>
          {% elif p == total_pages - 3 and page < total_pages - 4 %}
            <li class="page-item disabled">
              <span class="page-link">...</span>
            </li>
          {% endif %}
        {% endfor %}
        
        {% if page < total_pages %}
          <li class="page-item">
            <a class="page-link" href="{{ build_url(page + 1) }}"><i class="fas fa-chevron-right"></i></a>
          </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
</div>

<script>
// Page fade-in
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    document.getElementById('dashboardPageFade').classList.add('page-fade-in');
  }, 50);
});
</script>
{% endblock %}
