{% extends 'base.html' %}

{% block title %}Packer Performance{% endblock %}

{% block content %}
<div class="card shadow-sm p-4 mb-4 page-fade" id="performancePageFade" data-aos="fade-up">
  <h2 class="mb-3 text-primary">Packer Performance (Cases Packed Per Day)</h2>
  <form method="get" action="/performance" class="row g-3 align-items-center mb-3 needs-validation" novalidate>
    <div class="col-auto">
      <label for="packer" class="col-form-label">Filter by Packer Name:</label>
    </div>
    <div class="col-auto">
      <input type="text" id="packer" name="packer" class="form-control" value="{{ request.args.get('packer', '') }}">
    </div>
    <div class="col-auto">
      <label for="start_date" class="col-form-label">Start Date:</label>
    </div>
    <div class="col-auto">
      <input type="date" id="start_date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
    </div>
    <div class="col-auto">
      <label for="end_date" class="col-form-label">End Date:</label>
    </div>
    <div class="col-auto">
      <input type="date" id="end_date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary"><i class="bi bi-funnel"></i> Filter</button>
      <button type="button" class="btn btn-secondary" onclick="window.location.href='/performance'"><i class="bi bi-x-circle"></i> Clear</button>
    </div>
    <div class="col-auto">
      <button type="button" class="btn btn-info" onclick="goToChart()"><i class="bi bi-bar-chart"></i> View Performance Chart</button>
    </div>
  </form>
  <div class="mb-3 d-flex align-items-center gap-2">
    <form id="exportForm" method="get" action="/performance/export" class="d-flex align-items-center gap-2">
      <input type="hidden" name="packer" value="{{ request.args.get('packer', '') }}">
      <input type="hidden" name="start_date" value="{{ request.args.get('start_date', '') }}">
      <input type="hidden" name="end_date" value="{{ request.args.get('end_date', '') }}">
      <input type="hidden" name="page" value="{{ page }}">
      <select name="export_scope" class="form-select form-select-sm w-auto" style="min-width: 180px;">
        <option value="all">Export all filtered data</option>
        <option value="page">Export only this page</option>
      </select>
      <button type="submit" class="btn btn-success"><i class="bi bi-download"></i> Export CSV</button>
    </form>
  </div>
  {% if summary_stats %}
  <div class="alert alert-info mb-4" data-aos="fade-down">
    <div class="fw-bold mb-1">Summary for Filtered Results:</div>
    <div>Total Cases Packed: <strong>{{ summary_stats.total_cases }}</strong></div>
    <div>Unique Packers: <strong>{{ summary_stats.unique_packers }}</strong></div>
    <div>Average Cases per Packer: <strong>{{ summary_stats.avg_per_packer }}</strong></div>
    {% if summary_stats.unique_packers > 1 %}
    <div>Best Performer: <strong>{{ summary_stats.best[0] }}</strong> ({{ summary_stats.best[1] }} cases)</div>
    <div>Lowest Performer: <strong>{{ summary_stats.worst[0] }}</strong> ({{ summary_stats.worst[1] }} cases)</div>
    {% endif %}
  </div>
  {% endif %}
  {% if success_message %}
    <div class="alert alert-success" data-aos="fade-down">{{ success_message }}</div>
  {% endif %}
  {% if error_message %}
    <div class="alert alert-danger" data-aos="fade-down">{{ error_message }}</div>
  {% endif %}
  <div class="table-responsive" data-aos="fade-up">
    <table class="table table-striped table-bordered">
      <thead class="table-light">
        <tr>
          <th>Packer Name</th>
          <th>Date</th>
          <th>Total Cases Packed</th>
        </tr>
      </thead>
      <tbody>
        {% for packer_name, date, total_cases in records %}
        <tr>
          <td>{{ packer_name }}</td>
          <td>{{ date }}</td>
          <td>{{ total_cases }}</td>
        </tr>
        {% else %}
        <tr><td colspan="3" class="text-center">No records found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if total_pages > 1 %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center mt-3">
      <li class="page-item {% if page <= 1 %}disabled{% endif %}">
        <a class="page-link" href="{{ prev_url if prev_url else '#' }}">Previous</a>
      </li>
      {% for p, url in page_urls %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link" href="{{ url }}">{{ p }}</a>
      </li>
      {% endfor %}
      <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
        <a class="page-link" href="{{ next_url if next_url else '#' }}">Next</a>
      </li>
    </ul>
  </nav>
  {% endif %}
  <div class="mt-3">
    <a href="/" class="btn btn-link"><i class="bi bi-house"></i> Back to Home</a>
    <a href="/dashboard" class="btn btn-link"><i class="bi bi-table"></i> Go to Dashboard</a>
  </div>
</div>
<script>
// Page fade-in
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    document.getElementById('performancePageFade').classList.add('page-fade-in');
  }, 50);
});
function goToChart() {
  const packer = document.getElementById('packer').value;
  const start = document.getElementById('start_date').value;
  const end = document.getElementById('end_date').value;
  let url = '/performance/chart?';
  if (packer) url += `packer=${encodeURIComponent(packer)}&`;
  if (start) url += `start_date=${encodeURIComponent(start)}&`;
  if (end) url += `end_date=${encodeURIComponent(end)}&`;
  window.location.href = url;
}
// Bootstrap validation
(function () {
  'use strict';
  var forms = document.querySelectorAll('.needs-validation');
  Array.prototype.slice.call(forms).forEach(function (form) {
    form.addEventListener('submit', function (event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
})();
</script>
{% endblock %}
